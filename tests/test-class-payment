<?php

class Test_EDD_EZPay_Payment extends WP_UnitTestCase
{
    public $object;

    public function setUp()
    {
        parent::setUp();

        require_once 'helpers/class-helper-download.php';
        require_once 'helpers/class-helper-payment.php';
        require_once 'includes/class-payment.php';

        $this->object = EDD_EZPay_Payment::instance();

        edd_clear_errors();
    }

    public function tearDown()
    {
        parent::tearDown();
    }

    public function ttest_init()
    {
        $this->assertFalse( has_action( 'edd_gateway_ezpay', array(
            $this->object,
            'process_payment'
        ) ) );
        $this->assertFalse( has_action( 'edd_ezpay_nextypay', array(
            $this->object,
            'nextypay_action_handle'
        ) ) );

        $this->object->init();

        $this->assertNotFalse( has_action( 'edd_gateway_ezpay', array(
            $this->object,
            'process_payment'
        ) ) );
        $this->assertNotFalse( has_action( 'edd_ezpay_nextypay', array(
            $this->object,
            'nextypay_action_handle'
        ) ) );
    }

    public function test_redirect_to_success_page()
    {
        global $edd_options;
        $edd_options['ezpay_currency'] = array(
            array (
                'symbol' => 'nusd',
                'wallet' => 'currency-wallet',
                'lifetime' => 'currency-lifetime',
                'distance' => 'currency-distance',
                'discount' => '10'
            )
        );
        $purchase_data = [
            'post_data' => [
                'edd_ezpay_currency_symbol' => 'nusd'
            ]
        ];
        $gateway_response = array(
            'body' => '{"code":1,"data":[{"$__":{},"isNew":false,"_doc":{"_id":"id"},"$locals": {},"qr":""}],"message": "ok"}'
        );
        $payment_id = EDD_Helper_Payment::create_simple_payment();

        $mock = $this->getMockBuilder(EDD_EZPay_Payment::class)
            ->setMethods(['redirect_to_success_page', 'create_edd_payment', 'create_ezpay_payment'])
            ->getMock();

        $mock->expects($this->once())
            ->method('create_edd_payment')
            ->with($purchase_data)
            ->willReturn($payment_id);
        $mock->expects($this->once())
            ->method('create_ezpay_payment')
            ->with($payment_id, 'nusd')
            ->willReturn(json_decode($gateway_response['body']));
        $mock->expects($this->once())->method('redirect_to_success_page');

        $process = $mock->process_payment($purchase_data);

        $this->assertTrue( true !== $process );
        $this->assertNotNull( EDD()->session->get('edd_ezpay_payment') );
        $this->assertEquals( 'id', EDD()->session->get('edd_ezpay_payment')['data']['_doc']['_id'] );
    }

    private function create_fake_purchase_data()
    {
        $simple_download   = EDD_Helper_Download::create_simple_download();
        $variable_download = EDD_Helper_Download::create_variable_download();

        /** Generate some sales */
        $user      = get_userdata(1);
        $user_info = array(
            'id'            => $user->ID,
            'email'         => $user->user_email,
            'first_name'    => $user->first_name,
            'last_name'     => $user->last_name,
        );

        $download_details = array(
            array(
                'id' => $simple_download->ID,
                'options' => array(
                    'price_id' => 0
                )
            ),
            array(
                'id' => $variable_download->ID,
                'options' => array(
                    'price_id' => 1
                )
            ),
        );

        $total                  = 0;
        $simple_price           = get_post_meta( $simple_download->ID, 'edd_price', true );
        $variable_prices        = get_post_meta( $variable_download->ID, 'edd_variable_prices', true );
        $variable_item_price    = $variable_prices[1]['amount']; // == $100

        $total += $variable_item_price + $simple_price;

        $cart_details = array(
            array(
                'name'          => 'Test Download',
                'id'            => $simple_download->ID,
                'item_number'   => array(
                    'id'        => $simple_download->ID,
                    'options'   => array(
                        'price_id' => 1
                    )
                ),
                'price'         => $simple_price,
                'item_price'    => $simple_price,
                'tax'           => 0,
                'quantity'      => 1
            ),
            array(
                'name'          => 'Variable Test Download',
                'id'            => $variable_download->ID,
                'item_number'   => array(
                    'id'        => $variable_download->ID,
                    'options'   => array(
                        'price_id' => 1
                    )
                ),
                'price'         => $variable_item_price,
                'item_price'    => $variable_item_price,
                'tax'           => 0,
                'quantity'      => 1
            ),
        );

        $purchase_data = array(
            'price'         => number_format( (float) $total, 2 ),
            'date'          => date( 'Y-m-d H:i:s', strtotime( '-1 day' ) ),
            'purchase_key'  => strtolower( md5( uniqid() ) ),
            'user_email'    => $user_info['email'],
            'user_info'     => $user_info,
            'currency'      => 'USD',
            'downloads'     => $download_details,
            'cart_details'  => $cart_details,
            'status'        => 'pending',
        );

        return $purchase_data;
    }
}